# システム構成・アーキテクチャ設計書

## 1. システム構成図

```
                    ┌─────────────────────────────────────────┐
                    │            Internet                      │
                    └─────────────────┬───────────────────────┘
                                      │
                    ┌─────────────────▼───────────────────────┐
                    │         Route 53 (DNS)                  │
                    │         nokoroa.com                     │
                    └─────────────────┬───────────────────────┘
                                      │
                    ┌─────────────────▼───────────────────────┐
                    │         ACM (SSL/TLS証明書)             │
                    └─────────────────┬───────────────────────┘
                                      │
┌─────────────────────────────────────▼───────────────────────────────────────┐
│                              VPC (10.0.0.0/16)                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                        Public Subnet                                   │ │
│  │  ┌──────────────────────────────────────────────────────────────────┐  │ │
│  │  │                Application Load Balancer                         │  │ │
│  │  │                    (HTTP/HTTPS)                                  │  │ │
│  │  └───────────────────────┬──────────────────────────────────────────┘  │ │
│  └──────────────────────────┼─────────────────────────────────────────────┘ │
│                             │                                               │
│  ┌──────────────────────────▼─────────────────────────────────────────────┐ │
│  │                        Private Subnet                                  │ │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────────┐     │ │
│  │  │      ECS Fargate            │  │      ECS Fargate            │     │ │
│  │  │      (Frontend)             │  │      (Backend)              │     │ │
│  │  │      Next.js                │  │      NestJS                 │     │ │
│  │  │      Port: 3000             │  │      Port: 4000             │     │ │
│  │  └─────────────────────────────┘  └──────────────┬──────────────┘     │ │
│  │                                                   │                    │ │
│  │                          ┌────────────────────────┼────────────┐      │ │
│  │                          │                        │            │      │ │
│  │                          ▼                        ▼            │      │ │
│  │  ┌─────────────────────────────┐  ┌─────────────────────────┐ │      │ │
│  │  │         RDS                 │  │         S3              │ │      │ │
│  │  │      PostgreSQL             │  │    (画像ストレージ)     │ │      │ │
│  │  │      Port: 5432             │  │                         │ │      │ │
│  │  └─────────────────────────────┘  └─────────────────────────┘ │      │ │
│  │                                                               │      │ │
│  └───────────────────────────────────────────────────────────────┘      │ │
│                                                                          │ │
└──────────────────────────────────────────────────────────────────────────┘ │

                    ┌─────────────────────────────────────────┐
                    │         CloudWatch Logs                 │
                    │         (ログ収集・監視)                │
                    └─────────────────────────────────────────┘
```

---

## 2. 技術スタック

### 2.1 フロントエンド

| 項目 | 技術 |
|------|------|
| フレームワーク | Next.js 15 (App Router) |
| 言語 | TypeScript 5 |
| UIライブラリ | React 19 |
| CSSフレームワーク | Material-UI v7 |
| 状態管理 | React Context API |
| データフェッチ | SWR |
| フォーム | React Hook Form + Zod |
| 地図 | Google Maps JavaScript API |

### 2.2 バックエンド

| 項目 | 技術 |
|------|------|
| フレームワーク | NestJS 11 |
| 言語 | TypeScript 5 |
| ORM | Prisma 6 |
| 認証 | Passport.js (JWT, Google OAuth) |
| バリデーション | class-validator |
| APIドキュメント | Swagger/OpenAPI |
| テスト | Jest, Supertest |

### 2.3 インフラ

| 項目 | 技術 |
|------|------|
| クラウド | AWS |
| コンテナ | ECS Fargate |
| データベース | RDS PostgreSQL |
| ストレージ | S3 |
| DNS | Route 53 |
| SSL証明書 | ACM |
| ロードバランサー | ALB |
| ログ | CloudWatch Logs |
| IaC | Terraform |
| CI/CD | GitHub Actions |

---

## 3. デプロイフロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   開発者    │────▶│   GitHub    │────▶│   GitHub    │────▶│    AWS      │
│  git push   │     │   main      │     │   Actions   │     │    ECS      │
└─────────────┘     └─────────────┘     └─────────────┘     └─────────────┘
                                               │
                          ┌────────────────────┼────────────────────┐
                          │                    │                    │
                          ▼                    ▼                    ▼
                    ┌───────────┐       ┌───────────┐       ┌───────────┐
                    │   Lint    │       │   Test    │       │   Build   │
                    │  ESLint   │       │   Jest    │       │  Docker   │
                    └───────────┘       └───────────┘       └───────────┘
                                                                  │
                                                                  ▼
                                                            ┌───────────┐
                                                            │    ECR    │
                                                            │   Push    │
                                                            └───────────┘
                                                                  │
                                                                  ▼
                                                            ┌───────────┐
                                                            │    ECS    │
                                                            │  Deploy   │
                                                            └───────────┘
```

### 3.1 CI/CDパイプライン

1. **トリガー**: mainブランチへのpush
2. **CI**:
   - ESLint実行
   - Jest テスト実行
   - Prisma Client生成
   - ビルド確認
3. **CD**:
   - Dockerイメージビルド
   - ECRへプッシュ
   - ECSタスク定義更新
   - ECSサービスデプロイ
   - ヘルスチェック確認

---

## 4. セキュリティ構成

### 4.1 ネットワーク

- VPCで隔離されたネットワーク
- Public Subnet: ALBのみ配置
- Private Subnet: ECS, RDS配置
- Security Group: 必要なポートのみ開放

### 4.2 認証・認可

- JWT (HS256) による認証
- アクセストークン有効期限: 1日
- パスワード: bcrypt (10ラウンド)
- Google OAuth 2.0 対応

### 4.3 通信

- HTTPS (TLS 1.2以上)
- CORS: フロントエンドドメインのみ許可

---

## 5. 監視・ログ

### 5.1 ログ収集

| ログ種別 | 収集先 | 保持期間 |
|---------|--------|----------|
| アプリケーションログ | CloudWatch Logs | 30日 |
| アクセスログ | CloudWatch Logs | 30日 |
| エラーログ | CloudWatch Logs | 30日 |

### 5.2 メトリクス

- ECS: CPU使用率、メモリ使用率
- RDS: 接続数、CPU、ストレージ
- ALB: リクエスト数、レイテンシ

---

## 6. スケーリング戦略

### 6.1 ECS Auto Scaling

- 最小タスク数: 1
- 最大タスク数: 4
- スケールアウト条件: CPU > 70%
- スケールイン条件: CPU < 30%

### 6.2 RDS

- インスタンスタイプ: t3.micro (開発) / t3.small (本番)
- ストレージ: 20GB (自動拡張有効)
